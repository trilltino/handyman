use yew::prelude::*;
use stylist::yew::styled_component;
use wasm_bindgen_futures::spawn_local;
use web_sys::{HtmlInputElement, HtmlSelectElement, HtmlTextAreaElement};
use gloo_net::http::Request;

#[derive(Clone, PartialEq)]
pub enum WorkType {
    Plumbing,
    Electrical,
    Carpentry,
    Painting,
    GeneralRepair,
    Other,
}

impl WorkType {
    fn as_str(&self) -> &str {
        match self {
            WorkType::Plumbing => "Plumbing",
            WorkType::Electrical => "Electrical",
            WorkType::Carpentry => "Carpentry",
            WorkType::Painting => "Painting",
            WorkType::GeneralRepair => "General Repair",
            WorkType::Other => "Other",
        }
    }

    fn all() -> Vec<Self> {
        vec![
            WorkType::Plumbing,
            WorkType::Electrical,
            WorkType::Carpentry,
            WorkType::Painting,
            WorkType::GeneralRepair,
            WorkType::Other,
        ]
    }

    fn from_str(s: &str) -> Option<Self> {
        match s {
            "Plumbing" => Some(WorkType::Plumbing),
            "Electrical" => Some(WorkType::Electrical),
            "Carpentry" => Some(WorkType::Carpentry),
            "Painting" => Some(WorkType::Painting),
            "General Repair" => Some(WorkType::GeneralRepair),
            "Other" => Some(WorkType::Other),
            _ => None,
        }
    }

    fn base_price(&self) -> u32 {
        match self {
            WorkType::Plumbing => 15000,      // $150.00
            WorkType::Electrical => 18000,     // $180.00
            WorkType::Carpentry => 12000,      // $120.00
            WorkType::Painting => 10000,       // $100.00
            WorkType::GeneralRepair => 8000,   // $80.00
            WorkType::Other => 10000,          // $100.00
        }
    }
}

#[styled_component]
pub fn Booking() -> Html {
    // Simple state with use_state
    let location = use_state(|| String::new());
    let work_type = use_state(|| String::new());
    let description = use_state(|| String::new());
    let name = use_state(|| String::new());
    let email = use_state(|| String::new());
    let phone = use_state(|| String::new());
    let status = use_state(|| Option::<String>::None);
    let is_error = use_state(|| false);
    let is_submitting = use_state(|| false);
    let selected_work_type = use_state(|| Option::<WorkType>::None);

    // Calculate price based on work type
    let price = selected_work_type.as_ref().map(|wt| wt.base_price()).unwrap_or(0);

    // Simple onchange handlers
    let on_location_change = {
        let location = location.clone();
        Callback::from(move |e: Event| {
            let input: HtmlInputElement = e.target_unchecked_into();
            location.set(input.value());
        })
    };

    let on_work_type_change = {
        let work_type = work_type.clone();
        let selected_work_type = selected_work_type.clone();
        Callback::from(move |e: Event| {
            let select: HtmlSelectElement = e.target_unchecked_into();
            let value = select.value();
            work_type.set(value.clone());
            if let Some(wt) = WorkType::from_str(&value) {
                selected_work_type.set(Some(wt));
            }
        })
    };

    let on_description_change = {
        let description = description.clone();
        Callback::from(move |e: Event| {
            let textarea: HtmlTextAreaElement = e.target_unchecked_into();
            description.set(textarea.value());
        })
    };

    let on_name_change = {
        let name = name.clone();
        Callback::from(move |e: Event| {
            let input: HtmlInputElement = e.target_unchecked_into();
            name.set(input.value());
        })
    };

    let on_email_change = {
        let email = email.clone();
        Callback::from(move |e: Event| {
            let input: HtmlInputElement = e.target_unchecked_into();
            email.set(input.value());
        })
    };

    let on_phone_change = {
        let phone = phone.clone();
        Callback::from(move |e: Event| {
            let input: HtmlInputElement = e.target_unchecked_into();
            phone.set(input.value());
        })
    };

    let on_submit = {
        let location = location.clone();
        let work_type = work_type.clone();
        let description = description.clone();
        let name = name.clone();
        let email = email.clone();
        let phone = phone.clone();
        let status = status.clone();
        let is_error = is_error.clone();
        let is_submitting = is_submitting.clone();

        Callback::from(move |e: SubmitEvent| {
            e.prevent_default();

            let location_val = (*location).clone();
            let work_type_val = (*work_type).clone();
            let description_val = (*description).clone();
            let name_val = (*name).clone();
            let email_val = (*email).clone();
            let phone_val = (*phone).clone();
            let status = status.clone();
            let is_error = is_error.clone();
            let is_submitting = is_submitting.clone();

            is_submitting.set(true);

            spawn_local(async move {
                let body = serde_json::json!({
                    "location": location_val,
                    "workType": work_type_val,
                    "description": description_val,
                    "name": name_val,
                    "email": email_val,
                    "phone": phone_val
                });

                match Request::post("http://localhost:3000/api/booking")
                    .json(&body)
                    .unwrap()
                    .send()
                    .await
                {
                    Ok(_) => {
                        status.set(Some("Booking submitted successfully! We'll contact you soon.".to_string()));
                        is_error.set(false);
                        is_submitting.set(false);
                    }
                    Err(_) => {
                        status.set(Some("Error submitting booking. Please try again.".to_string()));
                        is_error.set(true);
                        is_submitting.set(false);
                    }
                }
            });
        })
    };

    let css = css!(
        r#"
        .booking-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-section {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .form-section h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 500;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            font-family: inherit;
            box-sizing: border-box;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .price-display {
            background: #e8f4f8;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            text-align: center;
        }

        .price-display h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.2rem;
        }

        .price-amount {
            color: #3498db;
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        #payment-element {
            margin: 1.5rem 0;
        }

        .submit-button {
            width: 100%;
            padding: 1rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-button:hover:not(:disabled) {
            background-color: #2980b9;
        }

        .submit-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .status-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 5px;
            text-align: center;
            background-color: #d4edda;
            color: #155724;
        }

        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        "#
    );

    html! {
        <div class={css}>
            <div class="booking-container">
                <h1>{ "Book a Handyman Service" }</h1>

                <form onsubmit={on_submit}>
                    <div class="form-section">
                        <h2>{ "Service Details" }</h2>

                        <div class="form-group">
                            <label for="location">{ "Service Location *" }</label>
                            <input
                                type="text"
                                id="location"
                                placeholder="Enter your address or location"
                                value={(*location).clone()}
                                onchange={on_location_change}
                                required=true
                                disabled={*is_submitting}
                            />
                        </div>

                        <div class="form-group">
                            <label for="workType">{ "Type of Work Needed *" }</label>
                            <select
                                id="workType"
                                value={(*work_type).clone()}
                                onchange={on_work_type_change}
                                required=true
                                disabled={*is_submitting}
                            >
                                <option value="">{ "Select work type..." }</option>
                                {
                                    WorkType::all().into_iter().map(|wt| {
                                        let value = wt.as_str().to_string();
                                        let label = wt.as_str().to_string();
                                        html! {
                                            <option value={value}>{ label }</option>
                                        }
                                    }).collect::<Html>()
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="description">{ "Work Description *" }</label>
                            <textarea
                                id="description"
                                placeholder="Describe the work you need done..."
                                value={(*description).clone()}
                                onchange={on_description_change}
                                required=true
                                disabled={*is_submitting}
                            />
                        </div>
                    </div>

                    <div class="form-section">
                        <h2>{ "Contact Information" }</h2>

                        <div class="form-group">
                            <label for="name">{ "Full Name *" }</label>
                            <input
                                type="text"
                                id="name"
                                value={(*name).clone()}
                                onchange={on_name_change}
                                required=true
                                disabled={*is_submitting}
                            />
                        </div>

                        <div class="form-group">
                            <label for="email">{ "Email *" }</label>
                            <input
                                type="email"
                                id="email"
                                value={(*email).clone()}
                                onchange={on_email_change}
                                required=true
                                disabled={*is_submitting}
                            />
                        </div>

                        <div class="form-group">
                            <label for="phone">{ "Phone Number *" }</label>
                            <input
                                type="tel"
                                id="phone"
                                value={(*phone).clone()}
                                onchange={on_phone_change}
                                required=true
                                disabled={*is_submitting}
                            />
                        </div>
                    </div>

                    if selected_work_type.is_some() {
                        <div class="form-section">
                            <h2>{ "Payment Information" }</h2>

                            <div class="price-display">
                                <h3>{ "Service Deposit" }</h3>
                                <div class="price-amount">
                                    { format!("${}.{:02}", price / 100, price % 100) }
                                </div>
                                <p>{ "Required to confirm your booking" }</p>
                            </div>

                            <p>{ "Payment integration coming soon!" }</p>
                        </div>
                    }

                    <button
                        type="submit"
                        class="submit-button"
                        disabled={*is_submitting}
                    >
                        { if *is_submitting { "Processing..." } else { "Book Now" } }
                    </button>
                </form>

                if let Some(msg) = (*status).clone() {
                    <div class={classes!("status-message", (*is_error).then(|| "error"))}>
                        { msg }
                    </div>
                }
            </div>
        </div>
    }
}
